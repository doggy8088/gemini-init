#!/usr/bin/env bash
# Gemini CLI è¨­å®šç²¾éˆ ğŸ§™â€â™‚ï¸âœ¨
set -euo pipefail

echo "ğŸŒŸ æ­¡è¿ä½¿ç”¨ Gemini è¨­å®šç²¾éˆï¼è®“æˆ‘å€‘ä¸€èµ·å»ºç«‹ .gemini/settings.json ğŸš€"

# å»ºç«‹ .gemini ç›®éŒ„
mkdir -p .gemini

# å»ºç«‹ç©º JSON
echo '{}' | jq '.' > .gemini/settings.json

###############################################################################
# äº’å‹•å¼è¼¸å…¥
###############################################################################

# 1. contextFileName
read -p "ğŸ“ è«‹è¼¸å…¥è¦åŠ å…¥ context çš„æª”æ¡ˆåç¨±(é€—è™Ÿåˆ†éš”ï¼Œé è¨­ .github/copilot-instructions.md,GEMINI.md): " context_files
context_files=${context_files:-".github/copilot-instructions.md,GEMINI.md"}

IFS=',' read -ra files <<< "$context_files"
jq '.contextFileName = []' .gemini/settings.json | sponge .gemini/settings.json
for f in "${files[@]}"; do
  jq --arg file "$f" '.contextFileName += [$file]' .gemini/settings.json | sponge .gemini/settings.json
done
echo "âœ… å·²åŠ å…¥ $(printf '%s ' "${files[@]}")"

# 2. preferredEditor é¸å–®(é è¨­ 2 - VS Code)
editor_keys=(zed vscode vscodium windsurf cursor vim neovim)
editor_names=("Zed" "VS Code" "VSCodium" "Windsurf" "Cursor" "Vim" "Neovim")

echo "ğŸ–‹ï¸ è«‹å¾ä¸‹åˆ—ç·¨è¼¯å™¨é¸æ“‡ç·¨è™Ÿ(ç›´æ¥ Enter å–é è¨­ 2 - VS Code)ï¸°"
for i in "${!editor_names[@]}"; do
  printf "  %2d) %s\n" $((i+1)) "${editor_names[$i]}"
done

read -p "ä½ çš„é¸æ“‡: " e_choice
e_choice=${e_choice:-2}
if ! [[ "$e_choice" =~ ^[1-7]$ ]]; then
  echo "âŒ ç„¡æ•ˆæ•¸å­—ï¼Œæ”¹ç”¨é è¨­ 2 - VS Code"
  e_choice=2
fi
preferred_editor="${editor_keys[$((e_choice-1))]}"
jq --arg pe "$preferred_editor" '.preferredEditor = $pe' .gemini/settings.json | sponge .gemini/settings.json
echo "âœ… preferredEditor è¨­å®šç‚º ${editor_names[$((e_choice-1))]}"

# 3. theme é¸å–®(é è¨­ 9 - GitHub)
themes=(
  "ANSI Light"
  "ANSI"
  "Atom One"
  "Ayu Light"
  "Ayu"
  "Default Light"
  "Default"
  "Dracula"
  "GitHub"
  "GitHub Light"
  "Google Code"
  "No Color"
  "Shades Of Purple"
)

echo "ğŸ¨ è«‹å¾ä¸‹åˆ—ä¸»é¡Œé¸æ“‡ç·¨è™Ÿ(ç›´æ¥ Enter å–é è¨­ 9 - GitHub)ï¸°"
for i in "${!themes[@]}"; do
  printf "  %2d) %s\n" $((i+1)) "${themes[$i]}"
done

read -p "ä½ çš„é¸æ“‡: " choice
choice=${choice:-9}
if ! [[ "$choice" =~ ^[1-9]$|^1[0-3]$ ]]; then
  echo "âŒ ç„¡æ•ˆæ•¸å­—ï¼Œæ”¹ç”¨é è¨­ 9 - GitHub"
  choice=9
fi
theme_name="${themes[$((choice-1))]}"
jq --arg th "$theme_name" '.theme = $th' .gemini/settings.json | sponge .gemini/settings.json
echo "âœ… theme è¨­å®šç‚º $theme_name"

###############################################################################
# mcpServers.github
###############################################################################

read -p "ğŸ™ æ˜¯å¦è¨­å®š GitHub MCP serverï¼Ÿ(y/N): " use_github
if [[ "${use_github,,}" == "y" ]]; then
  jq '.mcpServers.github = {}' .gemini/settings.json | sponge .gemini/settings.json
  jq '.mcpServers.github.command = "docker"' .gemini/settings.json | sponge .gemini/settings.json
  jq '.mcpServers.github.args = ["run","-i","--rm","-e","GITHUB_PERSONAL_ACCESS_TOKEN","ghcr.io/github/github-mcp-server"]' \
     .gemini/settings.json | sponge .gemini/settings.json
  jq '.mcpServers.github.env = {"GITHUB_PERSONAL_ACCESS_TOKEN":"$GITHUB_PERSONAL_ACCESS_TOKEN"}' \
     .gemini/settings.json | sponge .gemini/settings.json
  jq '.mcpServers.github.trust = true' .gemini/settings.json | sponge .gemini/settings.json
  echo "âœ… GitHub MCP server å·²è¨­å®š ğŸ‰"
else
  echo "â­ï¸ è·³é GitHub MCP server è¨­å®š"
fi

###############################################################################
# mcpServers.context7
###############################################################################

read -p "ğŸ”Œ æ˜¯å¦è¨­å®š Context7 MCP serverï¼Ÿ(y/N): " use_ctx7
if [[ "${use_ctx7,,}" == "y" ]]; then
  jq '.mcpServers.context7 = {}' .gemini/settings.json | sponge .gemini/settings.json
  jq '.mcpServers.context7.type = "stdio"' .gemini/settings.json | sponge .gemini/settings.json
  jq '.mcpServers.context7.command = "npx"' .gemini/settings.json | sponge .gemini/settings.json
  jq '.mcpServers.context7.args = ["-y","@upstash/context7-mcp"]' .gemini/settings.json | sponge .gemini/settings.json
  jq '.mcpServers.context7.trust = true' .gemini/settings.json | sponge .gemini/settings.json
  echo "âœ… Context7 MCP server å·²è¨­å®š ğŸš€"
else
  echo "â­ï¸ è·³é Context7 MCP server è¨­å®š"
fi

echo "ğŸŠ å…¨éƒ¨å®Œæˆï¼å·²ç”¢ç”Ÿ .gemini/settings.jsonï¼Œç¥é–‹ç™¼æ„‰å¿« ğŸ¤–"